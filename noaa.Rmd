---
title: "Historical Weather Event Dominates Economic Damage, while Excessive Heat Leads to Most Deaths "
author: "Kathryn Fahnline"
date: "4/12/2021"
output: 
  html_document:
    keep_md: true
---



## Synopsis

It is perhaps not surprising that the economic cost of Hurricane Katrina (2005) is an order of magnitude above all other weather events in the Storm data set (refer to Table 1).  What is perhaps unexpected is that excessive heat causes the most deaths (refer to Table 2). As my daughter pointed out, if the news outlets warn of a major impending storm, most reasonable people make plans to move out of harm's way. This is less likely to be true when there is a forecast of higher than normal temperatures; hence, the higher death rate.  While excessive heat causes the most deaths, tornados lead to a greater number of combined injuries and deaths -- and in 2011 there was a very large number of fatalities/injuries caused by tornados (see Figures 2 and 3).  

Does the document have a synopsis that describes and summarizes the data analysis in less than 10 sentences?

##  Data Processing

Thanks to Mentor Usama Khalil's useful post on cleaning the storm data.
[1]
[https://www.coursera.org/learn/reproducible-research/discussions/all/threads/38y35MMiEeiERhLphT2-QA]  and this guide to handling the coding of CROPDMGEXP and PROPDMGEXP [https://rstudio-pubs-static.s3.amazonaws.com/58957_37b6723ee52b455990e149edde45e5b6.html]


```{r cache=TRUE}
library(downloader)
fileUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
download.file(fileUrl, destfile = "noaa.csv.bz2", method="curl")
data <- read.csv("noaa.csv.bz2")
```

```{r state_region, cache=TRUE}
fileUrl <- "https://raw.githubusercontent.com/kjhealy/fips-codes/master/state_fips_master.csv"
download.file(fileUrl, destfile = "state_codes.csv", method="curl")
state_codes <- read.csv("state_codes.csv")
```

### I.  Data Transformation

#### Check out data and delete unnecessary columns

```{r explore_structure}
library(dplyr)
str(data)
data <- select(data, c(STATE, BGN_DATE, EVTYPE, FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP))
```

#### Filter data based on number of weather events in data set

From the NOAA website, I learned that starting in 1996, 48 event types are recorded in the Storm Events Database.  Before 1996, only tornado (1950-present), thunderstorm, wind and hail (1955-present) were recorded. [https://www.ncdc.noaa.gov/stormevents/details.jsp]  Because this assignment asks us to determine which events have the biggest effect on human health or largest economic impact, I have filtered for data set to only include records with the complete set of event data from 1996.

```{r filter_date, cache=TRUE}
library(lubridate)
data$year <- year(mdy_hms(data$BGN_DATE)) 
data<- data[data$year > 1995,]
```

#### Cleaning the event type names

The event names are not all coded in the same way, so I created a new variable, event, that has all lower case letters and standardized event names by making the following transformations: 

* tolower was used to change the event names to lower case
* grepl was used to find the index of for all variations of a specific event type 
* the index was used to replace all variations with the official name, as stated in the documentation.[https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf]

```{r official_names}
data$event <- tolower(data$EVTYPE)

official_event_names <- tolower(c("Astronomical Low Tide", "Avalanche,     Blizzard", "Coastal Flood","Cold/Wind Chill", "Debris Flow", "Dense Fog", "Dense Smoke", "Drought", "Dust Devil", "Dust Storm", "Excessive Heat", "Extreme Cold/Wind Chill", "Flash Flood", "Flood", "Frost/Freeze", "Funnel Cloud",  "Freezing Fog", "Hail", "Heat", "Heavy Rain", "Heavy Snow",  "High Surf", "High Wind", "Hurricane/Typhoon", "Ice Storm", "Lake-Effect-Snow", "Lakeshore Flood", "Lightning",  "Marine Hail", "Marine High Wind", "Marine Strong Wind", "Marine Thunderstorm Wind", "Rip Current", "Seiche", "Sleet",
 "Storm Surge/Tide", "Strong Wind", "Thunderstorm Wind", "Tornado", "Tropical Depression", "Tropical Storm",  "Tsunami", "Volcanic Ash", "Waterspout", "Wildfire",  "Winter Storm", "Winter Weather"))
```

```{r find_index}
a <- grepl("ashfall", data$event)
c <- grepl("coastal flood", data$event)
cf <- grepl("cstl flood", data$event)
cd <- grepl("[Dd]ry", data$event)
d <- grepl("[Cc]old", data$event)
f <- grepl("flash", data$event)
fz <- grepl("freeze", data$event)
fr <- grepl("freezing rain", data$event)
h <- grepl("hail", data$event)
hr <- grepl("hurricane", data$event)
l <- grepl("lake effect", data$event)
rp <- grepl("record precipitation", data$event)
rf <- grepl("rainfall", data$event)
r <- grepl("rain", data$event)
s <- grepl("snow", data$event)
sg <- grepl("surge", data$event)
sf <- grepl("surf", data$event)
t <- grepl("typhoon", data$event)
ts <- grepl("tstm", data$event)
wc <- grepl("windchill", data$event)

```

```{r replace_names}
library(stringr)
data$event[a == TRUE] <- "volcanic ash"
data$event[c == TRUE | cf == TRUE] <- "coastal flood"
data$event[c == TRUE | wc == TRUE] <- "extreme cold/wind chill"
data$event[d== TRUE] <- "drought"
data$event[f == TRUE] <- "flash flood"
data$event[rf==TRUE | rp==TRUE | r==TRUE ] <- "heavy rain"
data$event[fr == TRUE] <- "sleet"
data$event[fz == TRUE] <- "frost/freeze"
data$event[h == TRUE] <- "hail"
data$event[l == TRUE] <- "lake-effect"
data$event[sf == TRUE] <- "high surf"
data$event[s == TRUE] <- "heavy snow"
data$event[sg == TRUE] <- "storm surge/tide"
data$event[t == TRUE | hr == TRUE] <- "hurricane/typhoon"
data$event[ts == TRUE] <- "tsunami"
data$event <- str_replace(data$event, "strong winds", "strong wind")
data$event <- str_replace(data$event, "rip currents", "rip current")
data$event <- str_replace_all(data$event, "high wind (g40)", "high wind")
data$event <- str_replace_all(data$event, "dust devel", "dust devil")
data$event <- str_replace_all(data$event, "ice fog", "freezing fog")
```

There are some event names that are are not clearly in one of the standarized event types.  I decided to delete these instances from the data base. I checked to see which events did not match the official list after the above standardization.  

```{r check_names}
library(dplyr)
bad_names <- setdiff(data$event, official_event_names)
data <- filter(data, event %in% official_event_names)
```

#### Filter data set to exclude rows w/ either missing data for PROPDMGEXP or 
CROPDMGEXP

```{r filter_NA}
econ_df <- data[data$CROPDMGEXP != "" | 
                        data$PROPDMGEXP != "", ]
```

* Function to adjust for different units in CROPDMGEXP and PROPDMGEXP

```{r transform}
transform <- function (x, y) {

        if (x == "H" | x == "h")
                {y <- y * 10
        } else if (x == "K" | x == "k") 
                {y <- y * 10^3
        } else if (x == "M" | x == "m") 
                {y <- y * 10^6
        } else if (x == "B" | x == "b") 
                {y <- y * 10^9
        } else if (x == "-" | x == "?")
                 {y <- 0
        }
        y
}
```

* Use transform to adjust CROPDMGEXP and PROPDMGEXP

```{r, units}
econ_df$units_adj_cropdmg <- mapply(transform, 
                econ_df$CROPDMGEXP, econ_df$CROPDMG)
econ_df$units_adj_propdmg <- mapply(transform, 
                econ_df$PROPDMGEXP, econ_df$PROPDMG)
```

### II.  Data Analysis

#### A.  Economic Impact of Storms by Event Type

We were asked to explore which weather event type causes the most economic damage. To answer this question, I first found the total property and crop damage for each event type.  I then found the top ten most destructive weather types.   

* Find total property and crop damage by year for each event type and rank to find the 10 most expensive types.


```{r econ_stats}
table1 <- econ_df %>% group_by(event) %>% 
        summarize(total_property_damage = sum(units_adj_propdmg/10^6),
                  total_crop_damage = sum(units_adj_cropdmg/10^6)) %>%
        arrange(desc(total_property_damage)) %>%
        top_n(10)
```

```{r us, results="asis"}
library(gt)
library(dplyr)
tab = econ_df %>% 
        tibble() %>%
        group_by(event) %>%
        summarize(total_property_damage = sum(units_adj_propdmg/10^6),
                  total_crop_damage = sum(units_adj_cropdmg/10^6)) %>%
        arrange(desc(total_property_damage)) %>%
        top_n(10) %>%
        gt(rowname_col = "event") %>%
        tab_header(
        title = "Ten Most Costly Weather Events",
        subtitle = "1996-2011")  %>% 
        cols_align(align = "left") %>%
        tab_source_note(source_note = "Source:  NOAA Storm Data")  %>% 
        fmt_currency(
                columns = vars(total_property_damage), 
                currency = "USD", decimals = 0)  %>%
        cols_label(
                event = "Event",
                total_property_damage= "Total Property Damage",
                total_crop_damage = "Total Crop Damage"
                ) %>%
        opt_row_striping(row_striping = TRUE) %>%
        opt_table_outline() %>%
        tab_options(
                heading.background.color = "#85C1E9",
                row.striping.background_color = "#EBF5FB",
                column_labels.background.color = "#D6EAF8"
        )
print(tab)
```



Create factor variable for regions, adding territories and District of
Columbia.

```{r valid}
states <- c(state_codes$state_abbr, "AS", "GU", "PR", "VI", "DC")
valid <- econ_df$STATE %in% states
```

I filtered the data to only include rows with a valid state code.

```{r region}
region <- c(state_codes$region_name, "Territory", 
            "Territory", "Territory","Territory", "District")
econ_df$region <- factor(econ_df$STATE, levels = states,
                         labels = region)

econ_df <- econ_df[econ_df$STATE %in% states, ]
```

```{r region_table, results = "asis"}
library(gt)
library(dplyr)
tab1 = econ_df %>% 
        tibble() %>%
        group_by(region, event) %>%
        summarize(total_property_damage = 
                          sum(units_adj_propdmg)/10^6) %>%
        arrange(desc(total_property_damage)) %>% top_n(3) %>%
        gt(rowname_col = "event") %>%
        tab_header(
        title = "Most Costly Weather Events by Region",
        subtitle = "1996-2011")  %>% 
        cols_align(align = "left") %>%
        tab_source_note(source_note = "Source:  NOAA Storm Data")  %>% 
        fmt_currency(
                columns = vars(total_property_damage), 
                currency = "USD", decimals = 0)  %>%
        cols_label(
                total_property_damage = "Total Property Damage (Millions)",
                ) %>%
        #opt_row_striping(row_striping = TRUE) %>%
        opt_table_outline() %>%
        tab_options(
                heading.background.color = "#85C1E9",
                row_group.background.color = "#EBF5FB",
                column_labels.background.color = "#D6EAF8"
        )
print(tab1)
```

#### Create plot of yearly economic damage by the top 5 most destructive weather event types.  

* Create a new data set and subset to the top 5 most damaging weather event types
* Change event to a factor variable
* Filter the data set to include only the top 5 most damaging weather event  types
* Create a panel plot of the economic damage for the top 5 most damaging weather event types
* The y axis is total property damage in log(millions of dollars).  Note that the damage from Hurricane Katrina in 2005 is so much larger than the damage from other events that it was necessary to change to a log scale.


```{r plot_df}
library(dplyr)
top_five_damage <- econ_df %>% group_by(event) %>% 
        summarize(total_property_damage = sum(units_adj_propdmg/10^6),
                  total_crop_damage = sum(units_adj_cropdmg/10^6)) %>%
          arrange(desc(total_property_damage, total_crop_damage)) %>% top_n(5)

##create new data frame to plot
df <- econ_df %>% group_by(year, event) %>% 
        summarize(total_property_damage = sum(units_adj_propdmg)/10^6,
                  total_crop_damage = sum(units_adj_cropdmg)/10^6) 
str(top_five_damage)
plot <- filter(df, event %in% top_five_damage$event)
plot$event <- as.factor(plot$event)
```

```{r fig1, fig.width=10, fig.height=8}

library(ggplot2)
m <- max(plot$total_property_damage)
d <- ggplot(data=plot, aes(year)) +
  geom_line(aes(y=log(total_property_damage), 
                colour="total_property_damage")) +                geom_line(aes(y=log(total_crop_damage),                                                       colour = "total_crop_damage")) +
        labs(y="total cost", 
        title="Total Property and Crop Damage, 1996-2011", 
        subtitle=("log(Millions of US Dollars)"), 
        caption = "Figure 1") +
        facet_grid(.~ event) + 
        coord_cartesian(ylim=c(0, log(m))) 
        
print(d)
```

### B.  Human Impact of Weather Events 

We were asked to explore which weather event type causes the most harm to human health. To answer this question, I first found the total number of fatalities and injries for each event type.  I then found the top ten most injurious weather types.   

* Find total fatalities and injuries by year for each event type and rank to find the 10 most expensive types.

```{r health}
health <- data %>% group_by(event) %>% 
        summarize(total_fatalities = sum(FATALITIES),
                  total_injuries = sum(INJURIES) )

health <- filter(health, event %in% official_event_names)
health_table <- health %>% 
        arrange(desc(total_fatalities, total_injuries)) %>% top_n(10)
```


```{r table2, results = "asis"}
library(gt)
ht_tbl <- gt(health_table)
ht_tbl <- ht_tbl %>%
 tab_header(
    title = "Weather Types Ranked by Impact on Human Health",
    subtitle = "1996-2001"
    ) 
ht_tbl <- ht_tbl %>%
  tab_source_note(
  source_note = "Source:  NOAA Storm Data"
) 
ht_tbl <- ht_tbl %>% cols_label(
  event = "Event",
  total_fatalities = "Total Fatalities",
  total_injuries = "Total Injuries"
)
ht_tbl <- opt_row_striping(ht_tbl, row_striping = TRUE)
ht_tbl <- opt_table_outline(ht_tbl)
ht_tbl
```

*  Create a new data frame to plot health effects by storm type

```{r fig2, fig.width=10, fig.height=8}

top_health <- filter(health, event %in% official_event_names) %>%
          arrange(desc(total_fatalities, total_injuries)) %>% top_n(5)

##create new data frame to plot
df2 <- data %>% group_by(year, event) %>% 
        summarize(total_fatalities = sum(FATALITIES),
                  total_injuries = sum(INJURIES))

plot2 <- filter(df2, event %in% top_health$event)
plot2$event <- as.factor(plot2$event)

#plot <- filter(df, event %in% top_damage$event)
f<- max(plot2$total_fatalities)

g <- ggplot(data=plot2, aes(x=year)) +
       geom_col(aes(y=total_fatalities, fill=event)) +
       labs(title="Total Fatalties by Weather Event Type, 1996-2011",
       y="total number of persons",
       caption="Figure 2")  
       coord_cartesian(ylim=c(0, f)) 
print(g)      
```

*  Create a new data frame to plot health effects by storm type

```{r fig3, fig.width=10, fig.height=8}

#plot <- filter(df, event %in% top_damage$event)
i<- max(plot2$total_fatalities)

h <- ggplot(data=plot2, aes(x=year)) +
       geom_col(aes(y=total_injuries, fill=event)) +
       labs(title="Total Injuries by Weather Event Type, 1996-2011",
       y="total number of persons",
       caption="Figure 3")  
       coord_cartesian(ylim=c(0, i)) 
print(h)  
```

### Conclusion


